# =============================================================================
# Project Aether - Azure Container Apps Deployment Workflow
# =============================================================================
# Triggers on push to master branch.
# Builds Docker images, pushes to ACR, and explicitly updates Container Apps.
#
# Required GitHub Secrets:
#   ACR_CA_LOGIN_SERVER     - ACR login server (acraetherdev.azurecr.io)
#   ACR_CA_USERNAME         - ACR admin username
#   ACR_CA_PASSWORD         - ACR admin password
#   AZURE_CREDENTIALS       - Azure service principal JSON for az login
#                             (or use AZURE_CLIENT_ID, AZURE_TENANT_ID,
#                              AZURE_SUBSCRIPTION_ID with OIDC)
#
# Container Apps:
#   Backend:  ca-aether-ca-dev-api  (rg-aether-ca-dev)
#   Frontend: ca-aether-ca-dev-web  (rg-aether-ca-dev)
#
# URLs:
#   Frontend: https://ca-aether-ca-dev-web.wonderfulsea-4938652c.westus2.azurecontainerapps.io
#   Backend:  https://ca-aether-ca-dev-api.wonderfulsea-4938652c.westus2.azurecontainerapps.io
# =============================================================================

name: Deploy to Container Apps

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'infrastructure/**'

  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: acraetherdev.azurecr.io
  RESOURCE_GROUP: rg-aether-ca-dev
  BACKEND_CONTAINER_APP: ca-aether-ca-dev-api
  FRONTEND_CONTAINER_APP: ca-aether-ca-dev-web
  BACKEND_IMAGE: acraetherdev.azurecr.io/aether-backend
  FRONTEND_IMAGE: acraetherdev.azurecr.io/aether-frontend
  WEB_FQDN: ca-aether-ca-dev-web.wonderfulsea-4938652c.westus2.azurecontainerapps.io
  API_FQDN: ca-aether-ca-dev-api.wonderfulsea-4938652c.westus2.azurecontainerapps.io

jobs:
  # ---------------------------------------------------------------------------
  # Build and Push Docker Images to ACR
  # ---------------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      deploy_backend: ${{ steps.check.outputs.deploy_backend }}
      deploy_frontend: ${{ steps.check.outputs.deploy_frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Determine what to deploy
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "deploy_backend=${{ github.event.inputs.deploy_backend }}" >> $GITHUB_OUTPUT
            echo "deploy_frontend=${{ github.event.inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
          else
            echo "deploy_backend=true" >> $GITHUB_OUTPUT
            echo "deploy_frontend=true" >> $GITHUB_OUTPUT
          fi

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_CA_USERNAME }}
          password: ${{ secrets.ACR_CA_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        if: steps.check.outputs.deploy_backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        if: steps.check.outputs.deploy_frontend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Deploy to Azure Container Apps
  # ---------------------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read

    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update backend Container App
        if: needs.build-and-push.outputs.deploy_backend == 'true'
        run: |
          echo "Deploying backend image: ${{ env.BACKEND_IMAGE }}:${{ needs.build-and-push.outputs.short_sha }}"
          az containerapp update \
            --name ${{ env.BACKEND_CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.BACKEND_IMAGE }}:${{ needs.build-and-push.outputs.short_sha }} \
            --revision-suffix "sha-${{ needs.build-and-push.outputs.short_sha }}"

      - name: Update frontend Container App
        if: needs.build-and-push.outputs.deploy_frontend == 'true'
        run: |
          echo "Deploying frontend image: ${{ env.FRONTEND_IMAGE }}:${{ needs.build-and-push.outputs.short_sha }}"
          az containerapp update \
            --name ${{ env.FRONTEND_CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.FRONTEND_IMAGE }}:${{ needs.build-and-push.outputs.short_sha }} \
            --revision-suffix "sha-${{ needs.build-and-push.outputs.short_sha }}"

      - name: Azure logout
        if: always()
        run: az logout

  # ---------------------------------------------------------------------------
  # Smoke Tests
  # ---------------------------------------------------------------------------
  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy
    permissions:
      contents: read

    steps:
      - name: Wait for new revisions to become active
        run: |
          echo "Waiting 60 seconds for new revisions to activate..."
          sleep 60

      - name: Health check - API
        run: |
          echo "Checking API health at https://${{ env.API_FQDN }}/api/v1/health"
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.API_FQDN }}/api/v1/health" || echo "000")
            echo "Attempt $i: HTTP $HTTP_STATUS"
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "API health check passed!"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "WARNING: API health check failed after 5 attempts (HTTP $HTTP_STATUS)"
            fi
            sleep 15
          done

      - name: Health check - Web
        run: |
          echo "Checking Web at https://${{ env.WEB_FQDN }}"
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.WEB_FQDN }}" || echo "000")
            echo "Attempt $i: HTTP $HTTP_STATUS"
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Web health check passed!"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "WARNING: Web health check failed after 5 attempts (HTTP $HTTP_STATUS)"
            fi
            sleep 15
          done

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "Container Apps Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "URLs:"
          echo "  Frontend: https://${{ env.WEB_FQDN }}"
          echo "  Backend:  https://${{ env.API_FQDN }}"
          echo "  API Docs: https://${{ env.API_FQDN }}/docs"
          echo ""
          echo "Revision: sha-${{ needs.deploy.result }}"
          echo "=========================================="
