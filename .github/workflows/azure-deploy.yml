# =============================================================================
# Project Aether - Azure Deployment Workflow
# =============================================================================
# This workflow deploys the application to Azure App Service using webhooks
#
# Required secrets:
#   ACR_LOGIN_SERVER    - Azure Container Registry login server
#   ACR_USERNAME        - ACR admin username
#   ACR_PASSWORD        - ACR admin password
#   FRONTEND_WEBHOOK_URL - Azure App Service webhook for frontend
#   BACKEND_WEBHOOK_URL  - Azure App Service webhook for backend
# =============================================================================

name: Deploy to Azure

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  # ---------------------------------------------------------------------------
  # Build and Push Docker Images
  # ---------------------------------------------------------------------------
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_backend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/aether-backend:latest
            ${{ env.REGISTRY }}/aether-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_frontend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/aether-frontend:latest
            ${{ env.REGISTRY }}/aether-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Deploy via Webhooks
  # ---------------------------------------------------------------------------
  deploy:
    needs: build-push
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Backend Deployment
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_backend == 'true' }}
        run: |
          echo "Triggering backend deployment..."
          curl -X POST "${{ secrets.BACKEND_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --fail --silent --show-error
          echo "Backend deployment triggered!"

      - name: Trigger Frontend Deployment
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_frontend == 'true' }}
        run: |
          echo "Triggering frontend deployment..."
          curl -X POST "${{ secrets.FRONTEND_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --fail --silent --show-error
          echo "Frontend deployment triggered!"

      - name: Wait for deployments
        run: |
          echo "Waiting 60 seconds for containers to pull and restart..."
          sleep 60

      - name: Health Check - Backend
        run: |
          echo "Checking backend health..."
          for i in {1..10}; do
            if curl -sf "https://aether-dev-api-04w9l0.azurewebsites.net/health" -o /dev/null; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i/10 - Backend not ready, waiting 10 seconds..."
            sleep 10
          done
          echo "‚ö†Ô∏è Backend health check timed out (may still be starting)"

      - name: Health Check - Frontend
        run: |
          echo "Checking frontend health..."
          for i in {1..5}; do
            if curl -sf "https://aether-dev-web-04w9l0.azurewebsites.net" -o /dev/null; then
              echo "‚úÖ Frontend is healthy!"
              exit 0
            fi
            echo "Attempt $i/5 - Frontend not ready, waiting 10 seconds..."
            sleep 10
          done
          echo "‚ö†Ô∏è Frontend health check timed out (may still be starting)"

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "üöÄ Deployment Complete!"
          echo "=========================================="
          echo "Frontend: https://aether-dev-web-04w9l0.azurewebsites.net"
          echo "Backend:  https://aether-dev-api-04w9l0.azurewebsites.net"
          echo "API Docs: https://aether-dev-api-04w9l0.azurewebsites.net/docs"
          echo "=========================================="
