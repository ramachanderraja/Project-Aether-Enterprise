# =============================================================================
# Project Aether - Azure Deployment Workflow
# =============================================================================
# This workflow builds Docker images and pushes to ACR.
# Azure App Service has Continuous Deployment enabled and will auto-pull
# the latest images when they're pushed to ACR.
#
# Required secrets:
#   ACR_LOGIN_SERVER    - Azure Container Registry login server
#   ACR_USERNAME        - ACR admin username
#   ACR_PASSWORD        - ACR admin password
# =============================================================================

name: Deploy to Azure

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  # ---------------------------------------------------------------------------
  # Build and Push Docker Images
  # ---------------------------------------------------------------------------
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_backend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/aether-backend:latest
            ${{ env.REGISTRY }}/aether-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_frontend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/aether-frontend:latest
            ${{ env.REGISTRY }}/aether-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "ðŸš€ Images pushed to ACR!"
          echo "=========================================="
          echo ""
          echo "Backend:  ${{ env.REGISTRY }}/aether-backend:latest"
          echo "Frontend: ${{ env.REGISTRY }}/aether-frontend:latest"
          echo ""
          echo "Azure App Service will auto-pull new images within 5 minutes."
          echo ""
          echo "If you need immediate deployment, run:"
          echo "  az webapp restart --name aether-dev-web-04w9l0 --resource-group aether-dev-rg"
          echo "  az webapp restart --name aether-dev-api-04w9l0 --resource-group aether-dev-rg"
          echo ""
          echo "URLs:"
          echo "  Frontend: https://aether-dev-web-04w9l0.azurewebsites.net"
          echo "  Backend:  https://aether-dev-api-04w9l0.azurewebsites.net"
          echo "  API Docs: https://aether-dev-api-04w9l0.azurewebsites.net/docs"
          echo "=========================================="
