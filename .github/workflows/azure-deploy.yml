# =============================================================================
# Project Aether - Azure Container Apps Deployment Workflow
# =============================================================================
# This workflow builds Docker images and pushes to ACR.
# Container Apps will be updated manually or via Azure CLI after push.
#
# Required secrets:
#   ACR_LOGIN_SERVER    - Azure Container Registry login server
#   ACR_USERNAME        - ACR admin username
#   ACR_PASSWORD        - ACR admin password
#
# To deploy after images are pushed, run:
#   az containerapp update --name aether-api --resource-group aether-dev-rg --image aetherdevacr04w9l0.azurecr.io/aether-backend:latest
#   az containerapp update --name aether-web --resource-group aether-dev-rg --image aetherdevacr04w9l0.azurecr.io/aether-frontend:latest
# =============================================================================

name: Build and Push to ACR

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Build Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Build Backend'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  # ---------------------------------------------------------------------------
  # Build and Push Docker Images
  # ---------------------------------------------------------------------------
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_backend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/aether-backend:latest
            ${{ env.REGISTRY }}/aether-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        if: ${{ github.event_name == 'push' || github.event.inputs.deploy_frontend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/aether-frontend:latest
            ${{ env.REGISTRY }}/aether-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Container Apps
        run: |
          # Install Azure CLI
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

          # Login using service principal
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"

          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

          # Update Container Apps with new images
          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event.inputs.deploy_backend }}" == "true" ]; then
            echo "Deploying backend..."
            az containerapp update \
              --name aether-api \
              --resource-group aether-dev-rg \
              --image ${{ env.REGISTRY }}/aether-backend:${{ github.sha }} || echo "Backend deploy failed - may need role assignment"
          fi

          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event.inputs.deploy_frontend }}" == "true" ]; then
            echo "Deploying frontend..."
            az containerapp update \
              --name aether-web \
              --resource-group aether-dev-rg \
              --image ${{ env.REGISTRY }}/aether-frontend:${{ github.sha }} || echo "Frontend deploy failed - may need role assignment"
          fi

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "ðŸš€ Images pushed to ACR!"
          echo "=========================================="
          echo ""
          echo "Backend:  ${{ env.REGISTRY }}/aether-backend:${{ github.sha }}"
          echo "Frontend: ${{ env.REGISTRY }}/aether-frontend:${{ github.sha }}"
          echo ""
          echo "Container Apps URLs:"
          echo "  Frontend: https://aether-web.orangesea-d82907cf.westus2.azurecontainerapps.io"
          echo "  Backend:  https://aether-api.orangesea-d82907cf.westus2.azurecontainerapps.io"
          echo "  API Docs: https://aether-api.orangesea-d82907cf.westus2.azurecontainerapps.io/docs"
          echo ""
          echo "If deployment failed, manually update with:"
          echo "  az containerapp update --name aether-api --resource-group aether-dev-rg --image ${{ env.REGISTRY }}/aether-backend:${{ github.sha }}"
          echo "  az containerapp update --name aether-web --resource-group aether-dev-rg --image ${{ env.REGISTRY }}/aether-frontend:${{ github.sha }}"
          echo "=========================================="
